# Casting cost

## General Observations

- bitsandbytes doesn't perform well
- mostly the on the fly ones work well, although Qx_K_S perform better or as well and are slightly smaller
- there is a very strong dependance on depth in the model, though not entirely monotonic
- some interesting variation in last 10 or so layers with smaller quants performing very badly
- the quantisation or not of bias (the difference between Q4_1 and Q4_1* and similar) seems to make no difference

Model - Flux.1.dev

Quantizations marked with (*) are patched in from GGUF models. Others are
quantised by this code.

In all models, the entry and exit layers are unquantised: 64,124,992 parameters

In all models, the normalisation scales are unquantised: 19,456 parameters

In patch models, block biases are unquantised: 3,035,136 parameters

|type|quantised|unquantised block biases|unquantised other|q%|
|:-:|-:|-:|-:|-:|
|fly|11,837,294,656|0|64,144,448|99.461%|
|patch|11,834,228,736|3,065,920|64,144,448|99.435%|


---

## Error (average MSE error in final hidden state) of quantising layers to different levels.

Note that layers 19-56 are single block (141,557,760 quantable parameters), 
layers 0-18 are double block (339,738,624 quantable parameters). Quantizing a double
block saves 2.4 times the memory of quantizing a single block. See weighted table below
to make comparisons between layers.


|-|Q8_0|bf8|Q6_K*|Q5_1|Q5_K_S*|Q4_1|Q4_1*|Q4_K_S*|Q4_0*|Q3_K_S*|Q2_K*|
|-|-:|-:|-:|-:|-:|-:|-:|-:|-:|-:|-:|
|bits|8.5|8|6.5625|6|5.5|5|5|4.5|4.5|3.4375|2.625|
|0| 61.301|| 68.684| 79.268| 91.402|110.990|110.960|125.260|183.730|331.730|652.650|
|1| 59.049|| 66.017| 79.055| 75.232| 97.950| 95.388|112.920|120.780|168.660|315.610|
|2| 52.052|| 57.607| 67.571| 72.492| 84.105| 82.944| 91.237|100.110|155.940|252.350|
|3| 46.173|| 50.708| 57.827| 58.888| 69.898| 70.468| 75.396| 76.786|113.890|173.610|
|4| 41.890|| 49.122| 57.455| 56.013| 73.359| 73.093| 72.959| 85.789|123.710|173.780|
|5| 40.371|| 45.968| 57.594| 53.946| 71.558| 70.572| 70.298| 77.101|105.310|167.140|
|6| 39.330|| 46.091| 54.982| 54.866| 69.990| 71.033| 69.467| 74.507| 99.927|171.260|
|7| 38.649|| 47.050| 58.501| 55.181| 73.138| 72.548| 74.795| 76.562|112.250|187.250|
|8| 39.691|| 45.321| 56.240| 55.221| 73.514| 72.145| 72.967| 74.278|104.670|176.220|
|9| 37.113|| 44.086| 53.990| 55.356| 71.753| 71.266| 72.076| 76.201|103.180|192.610|
|10| 42.300|| 49.434| 61.516| 63.087| 72.594| 73.166| 78.085| 85.732|110.230|165.180|
|11| 32.119|| 39.105| 48.114| 50.264| 64.662| 65.347| 65.917| 69.333| 97.697|162.110|
|12| 36.311|| 46.776| 56.112| 56.897| 71.314| 71.348| 73.896| 77.444| 99.562|139.030|
|13| 28.363|| 36.990| 44.029| 45.535| 60.592| 60.293| 59.012| 59.563| 93.597|144.570|
|14| 31.585|| 38.998| 45.968| 46.458| 59.777| 58.976| 56.921| 66.275| 88.855|131.790|
|15| 22.684|| 27.396| 34.331| 33.452| 51.835| 51.816| 42.946| 48.859| 72.874|129.310|
|16| 21.366|| 26.360| 33.128| 33.524| 45.384| 45.695| 50.804| 51.315| 69.755|130.860|
|17| 22.821|| 26.009| 34.614| 34.429| 47.378| 46.264| 41.880| 47.402| 71.642|147.760|
|18| 20.165|| 22.546| 27.116| 28.725| 36.467| 37.402| 39.689| 40.205| 64.070|204.030|
|19|  8.992|| 10.840| 13.120| 13.321| 18.577| 18.433| 17.755| 19.431| 32.293| 66.051|
|20|  7.014||  8.190| 10.336| 10.526| 14.754| 14.848| 14.212| 17.250| 27.637| 61.560|
|21|  5.661||  6.838|  8.600|  8.896| 14.101| 14.082| 13.667| 16.810| 29.931| 66.440|
|22|  4.301||  5.344|  6.731|  6.802| 11.502| 11.452| 11.354| 12.997| 29.641| 65.479|
|23|  3.228||  4.078|  5.311|  5.766|  9.433|  9.434|  9.333| 11.361| 22.168| 57.911|
|24|  2.611||  3.245|  4.398|  4.486|  8.574|  8.444|  8.521| 10.041| 25.752| 55.281|
|25|  2.228||  2.620|  3.870|  3.848|  7.794|  7.672|  7.317|  8.861| 20.823| 53.874|
|26|  2.008||  2.309|  3.313|  3.280|  6.301|  6.298|  5.955|  7.534| 17.519| 50.330|
|27|  1.797||  2.226|  3.087|  3.055|  6.473|  6.466|  5.791|  7.004| 17.471| 51.741|
|28|  1.724||  2.059|  3.022|  3.218|  6.767|  6.749|  6.088|  7.332| 17.565| 52.947|
|29|  1.654||  1.948|  2.783|  2.786|  5.849|  5.839|  5.571|  6.877| 16.025| 51.009|
|30|  1.593||  1.902|  2.746|  2.731|  5.622|  5.601|  5.008|  6.393| 15.292| 49.979|
|31|  1.517||  1.833|  2.630|  2.667|  5.408|  5.358|  5.000|  6.464| 15.007| 53.374|
|32|  1.489||  1.854|  2.651|  2.669|  5.463|  5.453|  5.104|  6.630| 16.677| 51.676|
|33|  1.431||  1.777|  2.571|  2.580|  5.411|  5.441|  4.833|  6.073| 15.490| 51.304|
|34|  1.365||  1.659|  2.407|  2.403|  4.817|  4.817|  4.407|  5.692| 13.118| 47.748|
|35|  1.349||  1.649|  2.454|  2.440|  4.821|  4.798|  4.364|  6.654| 14.165| 44.308|
|36|  1.279||  1.623|  2.326|  2.306|  4.650|  4.646|  4.205|  5.497| 14.435| 43.085|
|37|  1.194||  1.463|  2.091|  2.129|  4.095|  4.085|  3.743|  4.593| 10.838| 37.062|
|38|  1.140||  1.404|  2.022|  1.994|  3.855|  3.820|  3.617|  4.464| 11.213| 37.229|
|39|  1.131||  1.373|  1.992|  1.992|  4.215|  4.201|  3.556|  4.867| 10.457| 36.870|
|40|  1.078||  1.345|  2.054|  2.030|  4.331|  4.323|  3.953|  5.156| 12.249| 42.524|
|41|  1.056||  1.341|  2.022|  2.026|  4.365|  4.342|  4.082|  5.035| 12.288| 45.209|
|42|  1.002||  1.328|  2.163|  2.144|  4.869|  4.841|  4.251|  5.814| 15.131| 53.958|
|43|  0.956||  1.290|  2.088|  2.134|  5.198|  5.184|  4.506|  5.937| 15.065| 57.444|
|44|  0.963||  1.328|  2.343|  2.490|  6.147|  6.115|  6.208|  7.321| 19.369| 68.677|
|45|  0.904||  1.296|  2.304|  2.277|  6.381|  6.354|  5.321|  7.115| 18.907| 70.569|
|46|  0.848||  1.378|  2.626|  2.582|  7.748|  7.692|  6.535|  9.028| 24.860| 93.890|
|47|  0.750||  1.210|  2.490|  2.452|  7.172|  7.112|  6.270|  8.525| 26.381| 97.773|
|48|  0.730||  1.249|  2.684|  2.780|  7.873|  7.829|  7.327|  9.582| 30.304|115.310|
|49|  0.668||  1.365|  3.441|  3.314| 11.272| 11.243|  9.748| 13.770| 39.521|156.840|
|50|  0.634||  1.351|  3.585|  3.609| 11.870| 11.802| 11.562| 15.393| 42.105|172.190|
|51|  0.650||  1.555|  4.752|  4.705| 16.265| 16.093| 14.278| 20.733| 64.784|236.590|
|52|  0.530||  1.413|  4.236|  4.085| 15.376| 15.308| 13.765| 20.070| 55.817|223.320|
|53|  0.585||  1.700|  5.479|  6.318| 21.641| 21.406| 23.535| 44.167|119.310|355.650|
|54|  0.384||  1.705|  6.060|  5.700| 22.456| 22.218| 18.431| 27.048| 92.537|322.560|
|55|  0.183||  0.437|  1.217|  1.562|  4.200|  4.094|  4.365|  5.793| 19.676| 62.069|
|56|  0.137||  0.256|  0.308|  1.256|  0.926|  0.881|  4.313|  3.901| 19.450| 74.913|

---

## Weighted by parameter count

Same again, but the double block values divided by 2.4. So this is proportional to error per parameter quantized.


|-|Q8_0|bf8|Q6_K*|Q5_1|Q5_K_S*|Q4_1|Q4_1*|Q4_K_S*|Q4_0*|Q3_K_S*|Q2_K*|
|-|-:|-:|-:|-:|-:|-:|-:|-:|-:|-:|-:|
|bits|8.5|8|6.5625|6|5.5|5|5|4.5|4.5|3.4375|2.625|
|0| 25.542|| 28.618| 33.028| 38.084| 46.246| 46.233| 52.192| 76.554|138.221|271.938|
|1| 24.604|| 27.507| 32.940| 31.347| 40.812| 39.745| 47.050| 50.325| 70.275|131.504|
|2| 21.688|| 24.003| 28.155| 30.205| 35.044| 34.560| 38.015| 41.712| 64.975|105.146|
|3| 19.239|| 21.128| 24.095| 24.537| 29.124| 29.362| 31.415| 31.994| 47.454| 72.338|
|4| 17.454|| 20.468| 23.940| 23.339| 30.566| 30.455| 30.400| 35.745| 51.546| 72.408|
|5| 16.821|| 19.153| 23.998| 22.477| 29.816| 29.405| 29.291| 32.125| 43.879| 69.642|
|6| 16.387|| 19.205| 22.909| 22.861| 29.162| 29.597| 28.945| 31.045| 41.636| 71.358|
|7| 16.104|| 19.604| 24.375| 22.992| 30.474| 30.228| 31.165| 31.901| 46.771| 78.021|
|8| 16.538|| 18.884| 23.433| 23.009| 30.631| 30.060| 30.403| 30.949| 43.613| 73.425|
|9| 15.464|| 18.369| 22.496| 23.065| 29.897| 29.694| 30.032| 31.750| 42.992| 80.254|
|10| 17.625|| 20.598| 25.632| 26.286| 30.247| 30.486| 32.535| 35.722| 45.929| 68.825|
|11| 13.383|| 16.294| 20.047| 20.943| 26.943| 27.228| 27.465| 28.889| 40.707| 67.546|
|12| 15.130|| 19.490| 23.380| 23.707| 29.714| 29.728| 30.790| 32.268| 41.484| 57.929|
|13| 11.818|| 15.413| 18.345| 18.973| 25.247| 25.122| 24.588| 24.818| 38.999| 60.237|
|14| 13.160|| 16.249| 19.153| 19.358| 24.907| 24.573| 23.717| 27.615| 37.023| 54.913|
|15|  9.452|| 11.415| 14.305| 13.938| 21.598| 21.590| 17.894| 20.358| 30.364| 53.879|
|16|  8.902|| 10.983| 13.803| 13.968| 18.910| 19.040| 21.168| 21.381| 29.065| 54.525|
|17|  9.509|| 10.837| 14.422| 14.345| 19.741| 19.277| 17.450| 19.751| 29.851| 61.567|
|18|  8.402||  9.394| 11.298| 11.969| 15.195| 15.584| 16.537| 16.752| 26.696| 85.013|
|19|  8.992|| 10.840| 13.120| 13.321| 18.577| 18.433| 17.755| 19.431| 32.293| 66.051|
|20|  7.014||  8.190| 10.336| 10.526| 14.754| 14.848| 14.212| 17.250| 27.637| 61.560|
|21|  5.661||  6.838|  8.600|  8.896| 14.101| 14.082| 13.667| 16.810| 29.931| 66.440|
|22|  4.301||  5.344|  6.731|  6.802| 11.502| 11.452| 11.354| 12.997| 29.641| 65.479|
|23|  3.228||  4.078|  5.311|  5.766|  9.433|  9.434|  9.333| 11.361| 22.168| 57.911|
|24|  2.611||  3.245|  4.398|  4.486|  8.574|  8.444|  8.521| 10.041| 25.752| 55.281|
|25|  2.228||  2.620|  3.870|  3.848|  7.794|  7.672|  7.317|  8.861| 20.823| 53.874|
|26|  2.008||  2.309|  3.313|  3.280|  6.301|  6.298|  5.955|  7.534| 17.519| 50.330|
|27|  1.797||  2.226|  3.087|  3.055|  6.473|  6.466|  5.791|  7.004| 17.471| 51.741|
|28|  1.724||  2.059|  3.022|  3.218|  6.767|  6.749|  6.088|  7.332| 17.565| 52.947|
|29|  1.654||  1.948|  2.783|  2.786|  5.849|  5.839|  5.571|  6.877| 16.025| 51.009|
|30|  1.593||  1.902|  2.746|  2.731|  5.622|  5.601|  5.008|  6.393| 15.292| 49.979|
|31|  1.517||  1.833|  2.630|  2.667|  5.408|  5.358|  5.000|  6.464| 15.007| 53.374|
|32|  1.489||  1.854|  2.651|  2.669|  5.463|  5.453|  5.104|  6.630| 16.677| 51.676|
|33|  1.431||  1.777|  2.571|  2.580|  5.411|  5.441|  4.833|  6.073| 15.490| 51.304|
|34|  1.365||  1.659|  2.407|  2.403|  4.817|  4.817|  4.407|  5.692| 13.118| 47.748|
|35|  1.349||  1.649|  2.454|  2.440|  4.821|  4.798|  4.364|  6.654| 14.165| 44.308|
|36|  1.279||  1.623|  2.326|  2.306|  4.650|  4.646|  4.205|  5.497| 14.435| 43.085|
|37|  1.194||  1.463|  2.091|  2.129|  4.095|  4.085|  3.743|  4.593| 10.838| 37.062|
|38|  1.140||  1.404|  2.022|  1.994|  3.855|  3.820|  3.617|  4.464| 11.213| 37.229|
|39|  1.131||  1.373|  1.992|  1.992|  4.215|  4.201|  3.556|  4.867| 10.457| 36.870|
|40|  1.078||  1.345|  2.054|  2.030|  4.331|  4.323|  3.953|  5.156| 12.249| 42.524|
|41|  1.056||  1.341|  2.022|  2.026|  4.365|  4.342|  4.082|  5.035| 12.288| 45.209|
|42|  1.002||  1.328|  2.163|  2.144|  4.869|  4.841|  4.251|  5.814| 15.131| 53.958|
|43|  0.956||  1.290|  2.088|  2.134|  5.198|  5.184|  4.506|  5.937| 15.065| 57.444|
|44|  0.963||  1.328|  2.343|  2.490|  6.147|  6.115|  6.208|  7.321| 19.369| 68.677|
|45|  0.904||  1.296|  2.304|  2.277|  6.381|  6.354|  5.321|  7.115| 18.907| 70.569|
|46|  0.848||  1.378|  2.626|  2.582|  7.748|  7.692|  6.535|  9.028| 24.860| 93.890|
|47|  0.750||  1.210|  2.490|  2.452|  7.172|  7.112|  6.270|  8.525| 26.381| 97.773|
|48|  0.730||  1.249|  2.684|  2.780|  7.873|  7.829|  7.327|  9.582| 30.304|115.310|
|49|  0.668||  1.365|  3.441|  3.314| 11.272| 11.243|  9.748| 13.770| 39.521|156.840|
|50|  0.634||  1.351|  3.585|  3.609| 11.870| 11.802| 11.562| 15.393| 42.105|172.190|
|51|  0.650||  1.555|  4.752|  4.705| 16.265| 16.093| 14.278| 20.733| 64.784|236.590|
|52|  0.530||  1.413|  4.236|  4.085| 15.376| 15.308| 13.765| 20.070| 55.817|223.320|
|53|  0.585||  1.700|  5.479|  6.318| 21.641| 21.406| 23.535| 44.167|119.310|355.650|
|54|  0.384||  1.705|  6.060|  5.700| 22.456| 22.218| 18.431| 27.048| 92.537|322.560|
|55|  0.183||  0.437|  1.217|  1.562|  4.200|  4.094|  4.365|  5.793| 19.676| 62.069|
|56|  0.137||  0.256|  0.308|  1.256|  0.926|  0.881|  4.313|  3.901| 19.450| 74.913|

Patches from (https://huggingface.co/city96/FLUX.1-dev-gguf)

